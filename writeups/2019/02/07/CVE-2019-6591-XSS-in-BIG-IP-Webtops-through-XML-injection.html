<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>CVE-2019-6591 - Reflected XSS in Big-IP APM | Hunter Stanton</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="CVE-2019-6591 - Reflected XSS in Big-IP APM" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Introduction" />
<meta property="og:description" content="Introduction" />
<link rel="canonical" href="http://localhost:4000/writeups/2019/02/07/CVE-2019-6591-XSS-in-BIG-IP-Webtops-through-XML-injection.html" />
<meta property="og:url" content="http://localhost:4000/writeups/2019/02/07/CVE-2019-6591-XSS-in-BIG-IP-Webtops-through-XML-injection.html" />
<meta property="og:site_name" content="Hunter Stanton" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-02-07T08:00:00-06:00" />
<script type="application/ld+json">
{"description":"Introduction","@type":"BlogPosting","url":"http://localhost:4000/writeups/2019/02/07/CVE-2019-6591-XSS-in-BIG-IP-Webtops-through-XML-injection.html","headline":"CVE-2019-6591 - Reflected XSS in Big-IP APM","dateModified":"2019-02-07T08:00:00-06:00","datePublished":"2019-02-07T08:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/writeups/2019/02/07/CVE-2019-6591-XSS-in-BIG-IP-Webtops-through-XML-injection.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Hunter Stanton" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Hunter Stanton</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">CVE-2019-6591 - Reflected XSS in Big-IP APM</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2019-02-07T08:00:00-06:00" itemprop="datePublished">Feb 7, 2019
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="introduction">Introduction</h2>

<p>Recently, I was doing recon during a private bug bounty program, and I came across an interesting endpoint. This endpoint appeared to be for corporate employees to be able to download a pre-configured VPN client so they could gain access to the corporate VPN. Here is what it looked like:</p>

<p><img src="/assets/20719/main.png" alt="Big-IP APM Webtops" /></p>

<p>As you can see, not much is provided outside of a few basic options, but I figured those basic options might still be hiding some vulnerabilities.</p>

<h2 id="investigating-the-attack-surface">Investigating the attack surface</h2>

<p>Like any bug seasoned bug hunter, I took note of a few things immediately:</p>
<ul>
  <li>The “Find Resource” option</li>
  <li>The “Logout” button (sign-in was not provided at any point, it appeared to auto-generate a session)</li>
  <li>The “Welcome to F5 Networks” text</li>
</ul>

<p>First, I decided to track down exactly what software was running here based on the URL of the page and the clues I was given. After a few quick Google searches, I determined it to be Big-IP APM with Webtops enabled. Next, I checked to see if there were any known vulnerabilities. Unfortunately, it didn’t seem like there were any that would work on the version this particular endpoint was running, so I knew that I needed to find a new vulnerability and would be able to get a CVE in Big-IP itself if I succeeded.</p>

<p>Next, I tried the basic stuff, such as XSS through the Find Resource functionality, by pasting in HTML tags into the search box. It all led to dead ends, so I knew I’d have to dig even deeper and it wouldn’t be simple to find a vulnerability. I fired up my proxy and refreshed the page to get a deeper look at the endpoints that were available. There weren’t a lot, considering the limited functionality of this endpoint.</p>

<p><img src="/assets/20719/endpoints.png" alt="Endpoints in Charles Proxy" /></p>

<p>There’s not a ton of endpoints that are available, as you can see, and the ones that are available are very limited.</p>

<h2 id="something-stands-out">Something Stands Out</h2>

<p>Immediately my eye was attracted to one in particular, <strong>“/vdesk/resource_list_v2.xml?prtn=/Common/&amp;wl_list=Client_Windows+Client_Mac”</strong> - it seemed to be the endpoint that was queried when the web page needed to get information about the applications that were available.</p>

<p><img src="/assets/20719/rlv2.png" alt="resource_list_v2.xml" /></p>

<p>I messed around with it a bit and discovered that arbitrary XML tags could be injected into the document through the “prtn” parameter, which would appear unmodified in the response. Since it’s XML we’re talking about here, I tried out injecting a DOCTYPE in the hopes that the server would potentially parse it, but that came up empty and it doesn’t seem to actually do anything with the response after it is generated other than send it to the user. On the other side of that same coin, I knew that if I could inject an XHTML script tag, XSS could be triggered because the browser would simply intepret it as an XHTML document.</p>

<p>My first attempt was met with failure - I could get a normal script tag in there, but it would not be parsed as XHTML. I needed to get the XHTML XMLNS attribute injected as well, so I crossed my fingers and tried it. Needless to say, it didn’t quite work, as the endpoint was automatically stripping out : from the prtn parameter, stopping you from forming the proper XMLNS attribute needed. At this point, I was defeated, and walked away for a few days. So close, yet so far away.</p>

<h2 id="a-few-days-later">A few days later…</h2>
<p>I thought about some ways to get past this problem. I remembered that you can encode any character as an HTML character entity, so I tried injecting the XMLNS attribute in my script tag encoded as HTML character entities. That didn’t work either, as the server was decoding them itself before generating the response, so it was treating it as if I didn’t encode it at all.</p>

<p>Then, I had another idea: what if I encoded the HTML character entities into HTML character entities? (so <strong>&amp;#x61;</strong> becomes <strong>&amp;#x26;&amp;#x23;&amp;#x78;&amp;#x36;&amp;#x31;&amp;#x3B;</strong>) I figured the server wouldn’t decode them twice, so I gave it a shot. Then this happened…</p>

<p><img src="/assets/20719/xss.png" alt="Successful cross-site scripting vulnerability" /></p>

<p>Turns out, when you double encode, the server <em>does</em> only decode once, and then the browser does the last step of the decoding and allows you to form the valid XHTML script tag, enabling reflected XSS to be performed in all browsers.</p>

<p>Furthermore, XSS cannot be triggered if the users session has expired. If try to perform the attack, and the victim lacks a valid session, the endpoint will 302 re-direct to establish a session. Fortunately for us, the endpoint that actually creates the session does <em>not</em> use iframe protection. An attacker can simply create a website that will establish a session using an iframe, and then redirect the victim to the XSS payload. This trick allows XSS regardless of if you have a valid session or not.</p>

<p>Happy with my victory, I quickly reported the issue to F5 Networks and the private bug bounty program.</p>

<h1 id="timeline">Timeline:</h1>

<p><strong>12/7/2018</strong> - Vulnerability Discovered, reported to F5 Networks</p>

<p><strong>12/17/2018</strong> - F5 Networks responds and says they have confirmed the vulnerability and are working on a patch</p>

<p><strong>1/29/2019</strong> - The vulnerability is resolved in Big-IP (APM) 14.1.0, 13.1.1.4, and 12.1.1 and assigned <strong>CVE-2019-6591</strong></p>

<h2 id="in-closing">In closing</h2>

<p>I’d just like to say that if something seems impossible at first, don’t stop hammering away at it. I almost walked away from this bug completely - I just happened to come back a while later and keep at it, because I had a hunch that there was a way to pull it off, and it turned out I was right in the end. I cannot tell you how many bugs I’ve found after dropping my investigation and then coming back a while later, refreshed and with some new ideas to try out. Never give up, and you’ll succeed eventually a lot of the time.</p>

<p>I’d just like to thank F5 Networks for being professional and fixing this issue promptly, and to thank you as well for reading this point. See you next time!</p>

  </div><a class="u-url" href="/writeups/2019/02/07/CVE-2019-6591-XSS-in-BIG-IP-Webtops-through-XML-injection.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Hunter Stanton</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Hunter Stanton</li><li><a class="u-email" href="mailto:hunter_stanton@outlook.com">hunter_stanton@outlook.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/hunterstanton"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">hunterstanton</span></a></li><li><a href="https://www.twitter.com/hunter_stanton"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">hunter_stanton</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Independent security researcher and iOS developer.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
